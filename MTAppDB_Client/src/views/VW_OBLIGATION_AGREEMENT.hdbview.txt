VIEW "VW_OBLIGATION_AGREEMENT" ( "ENTITY_ID",
	 "ENTITY_NAME",
	 "JURISDICTION_NAME",
	 "TAX_YEAR",
	 "IS_NO_OBLIGATION",
	 "IS_FATCA_OBLIGATION",
	 "FATCA_OBLIGATION_STATUS_ID",
	 "FATCA_OBLIGATION_STATUS_NAME",
	 "FATCA_FILING_REQUIREMENT_ID_PY",
	 "FATCA_FILING_REQUIREMENT_NAME_PY",
	 "FATCA_FILING_REQUIREMENT_ID_CY",
	 "FATCA_FILING_REQUIREMENT_NAME_CY",
	 "FATCA_FILING_REQUIREMENT_CHANGE_YOY",
	 "IS_CRS_OBLIGATION",
	 "CRS_OBLIGATION_STATUS_ID",
	 "CRS_OBLIGATION_STATUS_NAME",
	 "CRS_FILING_REQUIREMENT_ID_PY",
	 "CRS_FILING_REQUIREMENT_NAME_PY",
	 "CRS_FILING_REQUIREMENT_ID_CY",
	 "CRS_FILING_REQUIREMENT_NAME_CY",
	 "CRS_FILING_REQUIREMENT_CHANGE_YOY",
	 "IS_SUPPRESS_ENTITY" ) AS SELECT
	 ENTITY_ID,
	 ENTITY_NAME,
	 JURISDICTION_NAME,
	 TAX_YEAR,
	 IS_NO_OBLIGATION,
	 IS_FATCA_OBLIGATION,
	 FATCA_OBLIGATION_STATUS_ID,
	 FATCA_OBLIGATION_STATUS_NAME,
	 FATCA_FILING_REQUIREMENT_ID_PY,
	 FATCA_FILING_REQUIREMENT_NAME_PY,
	 FATCA_FILING_REQUIREMENT_ID_CY,
	 FATCA_FILING_REQUIREMENT_NAME_CY,
	 CASE WHEN (FATCA_FILING_REQUIREMENT_ID_PY = FATCA_FILING_REQUIREMENT_ID_CY) 
OR (FATCA_FILING_REQUIREMENT_ID_PY IN (2,
	 3,
	 4) 
	AND FATCA_FILING_REQUIREMENT_ID_CY IN (1)) 
OR (FATCA_FILING_REQUIREMENT_ID_PY IN( 1) 
	AND FATCA_FILING_REQUIREMENT_ID_CY IN (4) ) 
THEN 0 WHEN (FATCA_FILING_REQUIREMENT_ID_PY IN (2) 
	AND FATCA_FILING_REQUIREMENT_ID_CY IN (3,
	 4)) 
THEN -1 WHEN (FATCA_FILING_REQUIREMENT_ID_PY IN (4) 
	AND FATCA_FILING_REQUIREMENT_ID_CY IN (2,
	 3)) 
OR (FATCA_FILING_REQUIREMENT_ID_PY IN (3) 
	AND FATCA_FILING_REQUIREMENT_ID_CY IN (2)) 
OR (FATCA_FILING_REQUIREMENT_ID_PY IN (1) 
	AND FATCA_FILING_REQUIREMENT_ID_CY IN (2)) 
OR (FATCA_FILING_REQUIREMENT_ID_PY IN (1) 
	AND FATCA_FILING_REQUIREMENT_ID_CY IN (3)) 
THEN 1 
ELSE NULL 
END AS FATCA_FILING_REQUIREMENT_CHANGE_YOY,
	 IS_CRS_OBLIGATION,
	 CRS_OBLIGATION_STATUS_ID,
	 CRS_OBLIGATION_STATUS_NAME,
	 CRS_FILING_REQUIREMENT_ID_PY,
	 CRS_FILING_REQUIREMENT_NAME_PY,
	 CRS_FILING_REQUIREMENT_ID_CY,
	 CRS_FILING_REQUIREMENT_NAME_CY,
	 CASE WHEN (CRS_FILING_REQUIREMENT_ID_PY = CRS_FILING_REQUIREMENT_ID_CY) 
OR (CRS_FILING_REQUIREMENT_ID_PY IN (2,
	 3,
	 4) 
	AND CRS_FILING_REQUIREMENT_ID_CY IN (1)) 
OR (CRS_FILING_REQUIREMENT_ID_PY IN( 1) 
	AND CRS_FILING_REQUIREMENT_ID_CY IN (4) ) 
THEN 0 WHEN (CRS_FILING_REQUIREMENT_ID_PY IN (2) 
	AND CRS_FILING_REQUIREMENT_ID_CY IN (3,
	 4)) 
THEN -1 WHEN (CRS_FILING_REQUIREMENT_ID_PY IN (4) 
	AND CRS_FILING_REQUIREMENT_ID_CY IN (2,
	 3)) 
OR (CRS_FILING_REQUIREMENT_ID_PY IN (3) 
	AND CRS_FILING_REQUIREMENT_ID_CY IN (2)) 
OR (CRS_FILING_REQUIREMENT_ID_PY IN (1) 
	AND CRS_FILING_REQUIREMENT_ID_CY IN (2)) 
OR (CRS_FILING_REQUIREMENT_ID_PY IN (1) 
	AND CRS_FILING_REQUIREMENT_ID_CY IN (3)) 
THEN 1 
ELSE NULL 
END AS CRS_FILING_REQUIREMENT_CHANGE_YOY ,
	 IFNULL(IS_SUPPRESS_ENTITY,
	 'No') AS IS_SUPPRESS_ENTITY 
FROM ( SELECT
	 CY.ENTITY_ID AS ENTITY_ID,
	 CY.ENTITY_NAME AS ENTITY_NAME,
	 CY.JURISDICTION_NAME AS JURISDICTION_NAME,
	 CY.TAX_YEAR AS TAX_YEAR,
	 CY.IS_NO_OBLIGATION AS IS_NO_OBLIGATION,
	 CASE WHEN CY.IS_NO_OBLIGATION = 0 
	THEN CY.IS_FATCA_OBLIGATION 
	END AS IS_FATCA_OBLIGATION,
	 CY.FATCA_OBLIGATION_STATUS_ID AS FATCA_OBLIGATION_STATUS_ID,
	 CY.FATCA_OBLIGATION_STATUS_NAME AS FATCA_OBLIGATION_STATUS_NAME,
	 CASE WHEN CY.IS_NO_OBLIGATION = 0 
	THEN IFNULL(PY.FATCA_FILING_REQUIREMENT_ID,
	 4) 
	END AS FATCA_FILING_REQUIREMENT_ID_PY,
	 CASE WHEN CY.IS_NO_OBLIGATION = 0 
	THEN IFNULL(PY.FATCA_FILING_REQUIREMENT_NAME,
	 (SELECT
	 FILING_REQUIREMENT_NAME 
			FROM "FILING_REQUIREMENT" 
			WHERE FILING_REQUIREMENT_ID = 4)) 
	END AS FATCA_FILING_REQUIREMENT_NAME_PY,
	 CASE WHEN CY.IS_NO_OBLIGATION = 0 
	THEN IFNULL(CY.FATCA_FILING_REQUIREMENT_ID,
	 4) 
	END AS FATCA_FILING_REQUIREMENT_ID_CY,
	 CASE WHEN CY.IS_NO_OBLIGATION = 0 
	THEN IFNULL(CY.FATCA_FILING_REQUIREMENT_NAME,
	 (SELECT
	 FILING_REQUIREMENT_NAME 
			FROM "FILING_REQUIREMENT" 
			WHERE FILING_REQUIREMENT_ID = 4)) 
	END AS FATCA_FILING_REQUIREMENT_NAME_CY,
	 CASE WHEN CY.IS_NO_OBLIGATION = 0 
	THEN CY.IS_CRS_OBLIGATION 
	END AS IS_CRS_OBLIGATION,
	 CY.CRS_OBLIGATION_STATUS_ID AS CRS_OBLIGATION_STATUS_ID,
	 CY.CRS_OBLIGATION_STATUS_NAME AS CRS_OBLIGATION_STATUS_NAME,
	 CASE WHEN CY.IS_NO_OBLIGATION = 0 
	THEN IFNULL(PY.CRS_FILING_REQUIREMENT_ID,
	 4) 
	END AS CRS_FILING_REQUIREMENT_ID_PY,
	 CASE WHEN CY.IS_NO_OBLIGATION = 0 
	THEN IFNULL(PY.CRS_FILING_REQUIREMENT_NAME,
	 (SELECT
	 FILING_REQUIREMENT_NAME 
			FROM "FILING_REQUIREMENT" 
			WHERE FILING_REQUIREMENT_ID = 4)) 
	END AS CRS_FILING_REQUIREMENT_NAME_PY,
	 CASE WHEN CY.IS_NO_OBLIGATION = 0 
	THEN IFNULL(CY.CRS_FILING_REQUIREMENT_ID,
	 4) 
	END AS CRS_FILING_REQUIREMENT_ID_CY,
	 CASE WHEN CY.IS_NO_OBLIGATION = 0 
	THEN IFNULL(CY.CRS_FILING_REQUIREMENT_NAME,
	 (SELECT
	 FILING_REQUIREMENT_NAME 
			FROM "FILING_REQUIREMENT" 
			WHERE FILING_REQUIREMENT_ID = 4)) 
	END AS CRS_FILING_REQUIREMENT_NAME_CY ,
	 VES.IS_SUPPRESS_ENTITY AS IS_SUPPRESS_ENTITY 
	FROM ( SELECT
	 ENTITY.ENTITY_ID AS ENTITY_ID,
	 ENTITY.ENTITY_NAME AS ENTITY_NAME,
	 ENTITY.JURISDICTION_ID AS JURISDICTION_ID,
	 ENTITY.ENTITY_JURISDICTION.JURISDICTION_NAME AS JURISDICTION_NAME,
	 ENTITY.TAX_PERIOD_ID AS TAX_PERIOD_ID,
	 ENTITY.TAX_YEAR AS TAX_YEAR,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_ID IS NOT NULL 
			THEN 0 
			ELSE 1 
			END ) AS IS_NO_OBLIGATION,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 2 
			THEN 1 
			ELSE 0 
			END ) AS IS_FATCA_OBLIGATION,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 2 
			THEN ENTITY.OBLIGATION.OBLIGATION_STATUS_ID 
			END ) AS FATCA_OBLIGATION_STATUS_ID,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 2 
			THEN OS.DESCRIPTION 
			END ) AS FATCA_OBLIGATION_STATUS_NAME,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 2 
			THEN ENTITY.OBLIGATION.FILING_REQUIREMENT_ID 
			END ) AS FATCA_FILING_REQUIREMENT_ID,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 2 
			THEN FR.FILING_REQUIREMENT_NAME 
			END ) AS FATCA_FILING_REQUIREMENT_NAME,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 3 
			THEN 1 
			ELSE 0 
			END ) AS IS_CRS_OBLIGATION,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 3 
			THEN ENTITY.OBLIGATION.OBLIGATION_STATUS_ID 
			END ) AS CRS_OBLIGATION_STATUS_ID,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 3 
			THEN OS.DESCRIPTION 
			END ) AS CRS_OBLIGATION_STATUS_NAME,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 3 
			THEN ENTITY.OBLIGATION.FILING_REQUIREMENT_ID 
			END ) AS CRS_FILING_REQUIREMENT_ID,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 3 
			THEN FR.FILING_REQUIREMENT_NAME 
			END ) AS CRS_FILING_REQUIREMENT_NAME 
		FROM "VW_ENTITY_TD" ENTITY 
		LEFT JOIN "OBLIGATION_STATUS" OS ON OS.OBLIGATION_STATUS_ID = ENTITY.OBLIGATION.OBLIGATION_STATUS_ID 
		AND OS.STATUS_ID = 1 
		LEFT JOIN "FILING_REQUIREMENT" FR ON FR.FILING_REQUIREMENT_ID = ENTITY.OBLIGATION.FILING_REQUIREMENT_ID 
		AND FR.STATUS_ID = 1 
		WHERE ENTITY.ENTITY_ID IS NOT NULL 
		GROUP BY ENTITY.ENTITY_ID,
	 ENTITY.ENTITY_NAME,
	 ENTITY.JURISDICTION_ID,
	 ENTITY.ENTITY_JURISDICTION.JURISDICTION_NAME,
	 ENTITY.TAX_PERIOD_ID,
	 ENTITY.TAX_YEAR ) CY 
	LEFT JOIN "VW_ENTITY_SUPPRESSION" VES ON VES.ENTITY_ID = CY.ENTITY_ID 
	AND VES.TAX_PERIOD_ID = CY.TAX_PERIOD_ID 
	LEFT JOIN ( SELECT
	 ENTITY.ENTITY_ID AS ENTITY_ID,
	 ENTITY.TAX_PERIOD_ID AS TAX_PERIOD_ID,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 2 
			THEN ENTITY.OBLIGATION.FILING_REQUIREMENT_ID 
			END ) AS FATCA_FILING_REQUIREMENT_ID,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 2 
			THEN FR.FILING_REQUIREMENT_NAME 
			END ) AS FATCA_FILING_REQUIREMENT_NAME,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 3 
			THEN ENTITY.OBLIGATION.FILING_REQUIREMENT_ID 
			END ) AS CRS_FILING_REQUIREMENT_ID,
	 MAX ( CASE WHEN ENTITY.OBLIGATION.OBLIGATION_TYPE_ID = 3 
			THEN FR.FILING_REQUIREMENT_NAME 
			END ) AS CRS_FILING_REQUIREMENT_NAME 
		FROM ."VW_ENTITY_TD" ENTITY 
		LEFT JOIN "FILING_REQUIREMENT" FR ON ENTITY.OBLIGATION.FILING_REQUIREMENT_ID = FR.FILING_REQUIREMENT_ID 
		AND FR.STATUS_ID = 1 
		WHERE ENTITY.ENTITY_ID IS NOT NULL 
		GROUP BY ENTITY.ENTITY_ID,
	 ENTITY.TAX_PERIOD_ID ) PY ON CY.ENTITY_ID = PY.ENTITY_ID 
	AND CY.TAX_PERIOD_ID = PY.TAX_PERIOD_ID + 1 ) TMP_NULL_NR WITH READ ONLY